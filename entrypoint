#!/bin/bash

BIGCOUCH_SASL_LOGLEVEL=${BIGCOUCH_SASL_LOGLEVEL:-error}
BIGCOUCH_THREADS=${BIGCOUCH_THREADS:-25}
BIGCOUCH_LOG_LEVEL=${BIGCOUCH_LOG_LEVEL:-info}

BIGCOUCH_DATA_PATH=${BIGCOUCH_DATA_PATH:-/var/lib/bigcouch/data}
BIGCOUCH_BIND_ADDR=${BIGCOUCH_BIND_ADDR:-0.0.0.0}

BIGCOUCH_SHARDS=${BIGCOUCH_SHARDS:-1}
BIGCOUCH_READ_QUORUM=${BIGCOUCH_READ_QUORUM:-1}
BIGCOUCH_WRITE_QUORUM=${BIGCOUCH_WRITE_QUORUM:-1}
BIGCOUCH_REPLICAS=${BIGCOUCH_REPLICAS:-3}
BIGCOUCH_ZONES=${BIGCOUCH_ZONES:-1}

set -e
set -x

mkdir -p /tmp/bigcouch
chown bigcouch:bigcouch /tmp/bigcouch


if [ "$MOUNT_PERSISTENT_VOLUME" = true ]; then
    VOLUME_MOUNT_PATH="/mnt/bigcouch-data/$(hostname)"

    echo -e "Using Persistent Volume ...
    host: $(hostname)
    volume-mount-path: $VOLUME_MOUNT_PATH
    bigcouch-data-path: $BIGCOUCH_DATA_PATH
    "
    mkdir -p $VOLUME_MOUNT_PATH
    ln -sf $VOLUME_MOUNT_PATH $BIGCOUCH_DATA_PATH
    chown -R bigcouch:bigcouch $VOLUME_MOUNT_PATH
    chmod -R 0755 $VOLUME_MOUNT_PATH
fi


echo "Writing vm.args file ..."
tee /opt/bigcouch/etc/vm.args <<EOF
-name bigcouch@$(hostname -f)
-sasl errlog_type $BIGCOUCH_SASL_LOGLEVEL
+K true
+A $BIGCOUCH_THREADS
-kernel inet_dist_listen_min 11500 inet_dist_listen_max 11999
+Bd -noinput
-couch_ini /opt/bigcouch/etc/default.ini /opt/bigcouch/etc/local.ini

EOF
chown bigcouch:bigcouch /opt/bigcouch/etc/vm.args
chmod 0777 /opt/bigcouch/etc/vm.args


if [ -f '/etc/secrets/bigcouch/secret' ]; then
    BIGCOUCH_ADMIN_SECRET=$(cat /etc/secrets/bigcouch/secret)
    echo "Admin secret successfuly read from secret volume file ..."
else
    BIGCOUCH_ADMIN_SECRET=insecure-default
    echo "*** No secret file found at /etc/secrets/bigcouch/secret, using insecure backup ***"
fi


echo "Rewriting local.ini file ..."
[ -f /opt/bigcouch/etc/local.ini ] && rm -f /opt/bigcouch/etc/local.ini

# [admins]
# couch_admin = $BIGCOUCH_ADMIN_SECRET

tee /opt/bigcouch/etc/local.ini <<EOF
[couchdb]
database_dir = $BIGCOUCH_DATA_PATH
view_index_dir = $BIGCOUCH_DATA_PATH

[chttpd]
secret = $BIGCOUCH_ADMIN_SECRET
require_valid_user = false
port = 5984
bind_address = $BIGCOUCH_BIND_ADDR

[httpd]
secret = $BIGCOUCH_ADMIN_SECRET
require_valid_user = false
port = 5986
bind_address = $BIGCOUCH_BIND_ADDR

[cluster]
q=$BIGCOUCH_SHARDS
r=$BIGCOUCH_READ_QUORUM
w=$BIGCOUCH_WRITE_QUORUM
n=$BIGCOUCH_REPLICAS
z=$BIGCOUCH_ZONES

[log]
file = /var/log/bigcouch/bigcouch.log
level = $BIGCOUCH_LOG_LEVEL

EOF


if [ -f '/etc/secrets/erlang/cookie' ]; then
    echo "Cookie secret mounted ..."
    # touch ~/.erlang.cookie
    cookie=$(cat /etc/secrets/erlang/cookie)
    # yes | cp -rf /etc/secrets/erlang/cookie ~/.erlang.cookie
else
    echo "*** No Erlang Cookie Mounted! ***"
    # touch ~/.erlang.cookie
    cookie=insecure-cookie
    # echo insecure-cookie > ~/.erlang.cookie
fi
echo "$cookie" > ~/.erlang.cookie


echo "Ensuring correct permissions"
chown -R bigcouch:bigcouch /var/lib/bigcouch
chmod -R 0755 /opt/bigcouch /var/lib/bigcouch
chown bigcouch:bigcouch ~/.erlang.cookie #|| true
chmod 0600 ~/.erlang.cookie #|| true

echo "\nDEBUG: ***"
echo "user: $(whoami)"
echo "home: $HOME\n"
ls -la ~/
echo "***\n"


cd ~
    echo "Starting Bigcouch ..."
    export BEAM=beam
    export PATH=/opt/bigcouch/bin:/opt/bigcouch/erts-5.8.2/bin:$PATH
    export ERL_CRASH_DUMP=$(date +%s)_bigcouch_erl_crash.dump
    export ERL_LIBS=/opt/bigcouch/lib:$ERL_LIBS
    
    su bigcouch -c 'exec /opt/bigcouch/bin/bigcouch'

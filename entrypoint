#!/bin/bash

set -e

. ~/.bashrc

: ${BIGCOUCH_THREADS:=25}

# options: debug info warning error none
: ${BIGCOUCH_LOG_LEVEL:=info}
: ${BIGCOUCH_LOG_FILE:=}
: ${BIGCOUCH_LOG_SASL:=false}

: ${BIGCOUCH_DATA_PATH:=/var/lib/bigcouch/data}
: ${BIGCOUCH_BIND_ADDR:=0.0.0.0}

: ${BIGCOUCH_SHARDS:=1}
: ${BIGCOUCH_READ_QUORUM:=1}
: ${BIGCOUCH_WRITE_QUORUM:=1}
: ${BIGCOUCH_REPLICAS:=3}
: ${BIGCOUCH_ZONES:=1}


if [ "$MOUNT_PERSISTENT_VOLUME" = true ]; then
    VOLUME_MOUNT_PATH="/mnt/bigcouch-data/$(hostname)"

    echo -e "Using Persistent Volume ...
    host: $(hostname)
    volume-mount-path: $VOLUME_MOUNT_PATH
    bigcouch-data-path: $BIGCOUCH_DATA_PATH
    "
    mkdir -p $VOLUME_MOUNT_PATH
    ln -sf $VOLUME_MOUNT_PATH $BIGCOUCH_DATA_PATH
fi


echo "Writing vm.args file ..."
tee /opt/bigcouch/etc/vm.args <<EOF
-name bigcouch@$(hostname -f)
+K true
+A $BIGCOUCH_THREADS
-kernel inet_dist_listen_min 11500 inet_dist_listen_max 11999
+Bd -noinput
-couch_ini /opt/bigcouch/etc/default.ini /opt/bigcouch/etc/local.ini
EOF


echo "Rewriting local.ini file ..."
tee /opt/bigcouch/etc/local.ini <<EOF
[couchdb]
database_dir = $BIGCOUCH_DATA_PATH
view_index_dir = $BIGCOUCH_DATA_PATH

[chttpd]
require_valid_user = false
port = 5984
bind_address = $BIGCOUCH_BIND_ADDR

[httpd]
require_valid_user = false
port = 5986
bind_address = $BIGCOUCH_BIND_ADDR

[cluster]
q=$BIGCOUCH_SHARDS
r=$BIGCOUCH_READ_QUORUM
w=$BIGCOUCH_WRITE_QUORUM
n=$BIGCOUCH_REPLICAS
z=$BIGCOUCH_ZONES

[log]
level = $BIGCOUCH_LOG_LEVEL
file = $BIGCOUCH_LOG_FILE
include_sasl = $BIGCOUCH_LOG_SASL
EOF


echo "Reading erlang cookie ..."
if [ -f '/etc/secrets/erlang/cookie' ]; then
    echo "Cookie secret mounted ..."
    ERLANG_COOKIE=$(cat /etc/secrets/erlang/cookie)
else
    echo "*** No Erlang Cookie Mounted! ***"
    ERLANG_COOKIE=insecure-cookie
fi
echo "$ERLANG_COOKIE" > ~/.erlang.cookie


echo "Ensuring correct permissions ..."

chown -R bigcouch:bigcouch \
    ~ \
    /var/lib/bigcouch \
    /opt/bigcouch/etc \

chmod -R 0755 /opt/bigcouch /var/lib/bigcouch
chmod -R 0777 /opt/bigcouch/etc/*
chmod 0600 ~/.erlang.cookie 


cd ~
    echo "Starting Bigcouch ..."
    export BEAM=beam
    export PATH=/opt/bigcouch/erts-5.8.2/bin:$PATH
    export ERL_CRASH_DUMP=$(date +%s)_bigcouch_erl_crash.dump
    export ERL_LIBS=/opt/bigcouch/lib:$ERL_LIBS
    
    su bigcouch -c 'exec /opt/bigcouch/bin/bigcouch 2>&1'
